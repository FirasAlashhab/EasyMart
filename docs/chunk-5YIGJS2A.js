import{a as b,c as x,n as o,o as I}from"./chunk-2ZBRESMT.js";import{$ as m,S as l,W as g,k as d}from"./chunk-GFFIWVVQ.js";var p,y=new Uint8Array(16);function h(){if(!p&&(p=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!p))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return p(y)}var a=[];for(let i=0;i<256;++i)a.push((i+256).toString(16).slice(1));function B(i,s=0){return a[i[s+0]]+a[i[s+1]]+a[i[s+2]]+a[i[s+3]]+"-"+a[i[s+4]]+a[i[s+5]]+"-"+a[i[s+6]]+a[i[s+7]]+"-"+a[i[s+8]]+a[i[s+9]]+"-"+a[i[s+10]]+a[i[s+11]]+a[i[s+12]]+a[i[s+13]]+a[i[s+14]]+a[i[s+15]]}var v=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),k={randomUUID:v};function S(i,s,c){if(k.randomUUID&&!s&&!i)return k.randomUUID();i=i||{};let e=i.random||(i.rng||h)();if(e[6]=e[6]&15|64,e[8]=e[8]&63|128,s){c=c||0;for(let t=0;t<16;++t)s[c+t]=e[t];return s}return B(e)}var f=S;var A=(()=>{let s=class s{constructor(e,t){this.http=e,this.cookie=t,this.basketSource=new d(null),this.basket$=this.basketSource.asObservable(),this.basketTotalSource=new d(null),this.basketTotal$=this.basketTotalSource.asObservable(),this.shipping=0}createPaymentIntent(){let e=this.getCurrentBasketValue()?.id;if(!e)throw new Error("Basket ID not found.");let t=new b({Authorization:this.cookie.get("Authorization")||""});return this.http.post(`${o.apiBaseUrl}/api/payments/${e}`,{},{headers:t}).pipe(l(r=>{this.basketSource.next(r)}))}setShippingPrice(e){this.shipping=e.price;let t=this.getCurrentBasketValue();t&&(t.deliveryMethodId=e.id,t.shippingPrice=e.price,this.calculateTotals(),this.setBasket(t))}getBasket(e){return this.http.get(`${o.apiBaseUrl}/api/basket?id=${e}`).pipe(l(t=>{this.basketSource.next(t),typeof t.shippingPrice=="number"?this.shipping=t.shippingPrice:this.shipping=0,this.calculateTotals()}))}setBasket(e){return this.http.post(`${o.apiBaseUrl}/api/basket`,e).subscribe({next:t=>{this.basketSource.next(t),this.calculateTotals()},error:t=>{console.log(t)}})}getCurrentBasketValue(){return this.basketSource.value}addItemToBasket(e,t=1){let r=this.mapProductItemToBasketItem(e,t),n=this.getCurrentBasketValue()??this.createBasket();n.items=this.addOrUpdateItem(n.items,r,t),this.setBasket(n)}incrementItemQuantity(e){let t=this.getCurrentBasketValue();if(!t)return;let r=t.items.findIndex(n=>n.id===e.id);r!==-1&&(t.items[r].quantity++,this.setBasket(t))}decrementItemQuantity(e){let t=this.getCurrentBasketValue();if(!t)return;let r=t.items.findIndex(n=>n.id===e.id);t.items[r].quantity>1?(t.items[r].quantity--,this.setBasket(t)):this.removeItemFromBasket(e)}removeItemFromBasket(e){let t=this.getCurrentBasketValue();t?.items.some(r=>r.id===e.id)&&(t.items=t.items.filter(r=>r.id!==e.id),t.items.length>0?this.setBasket(t):this.deleteBasket(t))}deleteBasket(e){return this.http.delete(`${o.apiBaseUrl}/api/basket?id=${e.id}`).subscribe({next:t=>{this.basketSource.next(null),this.basketTotalSource.next(null),localStorage.removeItem("basket_id")},error:t=>{console.log(t)}})}deleteLocalBasket(){this.basketSource.next(null),this.basketTotalSource.next(null),localStorage.removeItem("basket_id")}addOrUpdateItem(e,t,r){let n=e.findIndex(u=>u.id===t.id);return n===-1?(t.quantity=r,e.push(t)):e[n].quantity+=r,e}createBasket(){let e={id:f(),items:[]};return localStorage.setItem("basket_id",e.id),e}calculateTotals(){let e=this.getCurrentBasketValue(),t=this.shipping,r=e?.items.reduce((n,u)=>u.price*u.quantity+n,0);if(r){let n=r+t;this.basketTotalSource.next({shipping:t,total:n,subtotal:r})}}mapProductItemToBasketItem(e,t){return{id:e.id,productName:e.name,price:e.price,pictureUrl:e.pictureUrl,quantity:t,brand:e.productBrand,type:e.productType}}};s.\u0275fac=function(t){return new(t||s)(m(x),m(I))},s.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})();export{A as a};
